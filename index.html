<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calypsia QR Code Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
  <style>
    :root {
      --primary: #6c5ce7;
      --secondary: #a29bfe;
      --dark: #2d3436;
      --light: #f5f6fa;
      --success: #00b894;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--dark);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      width: 100%;
    }
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    h1 {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      background: linear-gradient(to right, var(--primary), var(--success));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 0.5rem;
    }
    .app-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .qr-preview {
      flex: 1;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background: var(--light);
      border-radius: 12px;
      position: relative;
    }
    #qr-code {
      width: 100%;
      max-width: 300px;
      height: auto;
      aspect-ratio: 1/1;
    }
    .controls { 
      flex: 1; 
      min-width: 250px; 
    }
    .control-group { 
      margin-bottom: 1.2rem; 
    }
    .control-group h3 {
      margin-bottom: 0.6rem;
      color: var(--primary);
      font-size: 1rem;
    }
    input[type="text"], input[type="color"], input[type="file"], select {
      width: 100%;
      padding: 0.7rem;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.7rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      font-size: 0.9rem;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    .btn:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }
    .btn.active {
      background: var(--secondary) !important;
      color: #fff !important;
      box-shadow: 0 0 0 2px var(--primary);
    }
    .logo-preview {
      width: 50px;
      height: 50px;
      object-fit: contain;
      margin: 0.5rem auto;
      display: block;
      border-radius: 6px;
    }
    .custom-file-label {
      display: inline-block;
      background: var(--primary);
      color: #fff;
      padding: 0.7rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      margin-bottom: 0.5rem;
      transition: background 0.3s;
      font-size: 0.9rem;
      text-align: center;
      width: 100%;
    }
    .custom-file-label:hover {
      background: var(--secondary);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--primary);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    body.dark-mode {
      background: #23272f;
      color: #f5f6fa;
    }
    body.dark-mode .app-container {
      background: #2d3436;
      color: #f5f6fa;
    }
    body.dark-mode .qr-preview {
      background: #23272f;
    }
    body.dark-mode .btn, body.dark-mode .custom-file-label {
      background: var(--success);
      color: #fff;
    }
    body.dark-mode .btn:hover, body.dark-mode .custom-file-label:hover {
      background: var(--primary);
    }
    body.dark-mode input, body.dark-mode select {
      background: #23272f;
      color: #f5f6fa;
      border: 1px solid #444;
    }
    .bg-image-preview {
      width: 100%;
      height: 100%;
      max-width: 300px;
      max-height: 300px;
      object-fit: cover;
      margin: 0;
      display: block;
      border-radius: 8px;
    }
    #bgImageLayer.bg-image-preview {
      border: none;
      background: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      margin: 0;
      border-radius: 0;
      pointer-events: none;
    }
    .download-btns {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    .download-btns .btn {
      width: auto;
      min-width: 150px;
    }
    @media (max-width: 768px) {
      .container {
        padding: 0.5rem;
      }
      .app-container {
        padding: 1rem;
      }
      .qr-preview, .controls {
        min-width: 100%;
      }
      #qr-code {
        max-width: 250px;
      }
    }
    @media (max-width: 480px) {
      .app-container {
        padding: 0.75rem;
      }
      .control-group h3 {
        font-size: 0.9rem;
      }
      input[type="text"], input[type="color"], input[type="file"], select {
        padding: 0.6rem;
        font-size: 0.8rem;
      }
      .btn, .custom-file-label {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
      }
      .download-btns {
        flex-direction: column;
        align-items: center;
      }
      .download-btns .btn {
        width: 100%;
        max-width: 200px;
      }
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container">
    <header>
      <h1>QR Code Generator by bethces</h1>
    </header>
    <div class="app-container">
      <div class="qr-preview">
        <div style="position:relative; width:100%; max-width:300px; aspect-ratio:1/1;">
          <img id="bgImageLayer" class="bg-image-preview" style="display:none;" />
          <div id="qr-code" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;"></div>
        </div>
      </div>
      <div class="controls">
        <div class="control-group">
          <h3>QR Content</h3>
          <input type="text" id="qrText" placeholder="Enter URL or text">
        </div>
        <div class="control-group">
          <h3>Colors</h3>
          <label>Dot Color</label>
          <input type="color" id="dotColor" value="#000000">
          <label>Background Color</label>
          <input type="color" id="bgColor" value="#ffffff">
        </div>
        <div class="control-group">
          <h3>Dot Shape</h3>
          <select id="dotShape">
            <option value="square">Square</option>
            <option value="dots">Dots</option>
            <option value="rounded">Rounded</option>
          </select>
        </div>
        <div class="control-group">
          <h3>Center Logo</h3>
          <div style="display:flex;align-items:center;gap:1rem;">
            <img id="logoPreview" class="logo-preview" style="display:block;min-width:50px;min-height:50px;background:#222;" />
            <div style="flex:1;">
              <label class="custom-file-label" for="logoInput">Select Image</label>
              <input type="file" id="logoInput" accept="image/*" style="display:none;">
            </div>
          </div>
        </div>
        <div class="control-group">
          <h3>Background Image</h3>
          <label class="custom-file-label" for="bgImageInput">Select Background Image</label>
          <input type="file" id="bgImageInput" accept="image/*" style="display:none;">
          <button class="btn" id="toggleBgOpacityBtn" type="button">Toggle Transparency</button>
          <button class="btn" id="removeBgImageBtn" type="button">Remove Background Image</button>
        </div>
        <div class="control-group" style="display:flex; align-items:center;">
          <label class="switch">
            <input type="checkbox" id="darkModeToggle" checked>
            <span class="slider round"></span>
          </label>
          <span style="margin-left:10px;vertical-align:middle;">Dark Mode</span>
        </div>
        <button class="btn" id="generate-btn" style="display:none;">Generate QR Code</button>
      </div>
    </div>
    <div class="download-btns">
      <button class="btn" id="download-btn">Download PNG</button>
    </div>
    <div style="text-align:center; margin-top:0.5rem; font-size:0.95rem; color:#888;">
      You can export as <b>PNG</b> Main Dev :Betches.
    </div>
  </div>
  <script>
    const qrCode = new QRCodeStyling({
      width: 300,
      height: 300,
      data: "https://example.com",
      dotsOptions: { color: "#000000", type: "square" },
      backgroundOptions: { color: "#ffffff" },
      imageOptions: { crossOrigin: "anonymous", margin: 10 }
    });

    qrCode.append(document.getElementById("qr-code"));

    let backgroundImageData = null;
    let backgroundImageOpacity = 1;
    let backgroundImageType = null;
    let centerLogoType = null;
    let backgroundImageName = '';
    let centerLogoName = '';

    function updateQRCode() {
      const text = document.getElementById("qrText").value;
      const dotColor = document.getElementById("dotColor").value;
      let bgColor = document.getElementById("bgColor").value;
      const dotShape = document.getElementById("dotShape").value;
      // If background image is set, force background color to transparent
      if (backgroundImageData) {
        bgColor = "rgba(0,0,0,0)";
      }
      // Add artificial lag for color changes
      if (updateQRCode.lagTimeout) clearTimeout(updateQRCode.lagTimeout);
      if (updateQRCode.lagColor) {
        updateQRCode.lagTimeout = setTimeout(() => {
          let updateObj = {
            data: text,
            dotsOptions: { color: dotColor, type: dotShape },
            backgroundOptions: { color: bgColor },
          };
          qrCode.update(updateObj);
          updateQRCode.lagColor = false;
        }, 600); // 600ms lag
        return;
      }
      let updateObj = {
        data: text,
        dotsOptions: { color: dotColor, type: dotShape },
        backgroundOptions: { color: bgColor },
      };
      qrCode.update(updateObj);
    }

    // Add lag only for color pickers
    ["dotColor", "bgColor"].forEach(id => {
      document.getElementById(id).addEventListener("input", function() {
        updateQRCode.lagColor = true;
        updateQRCode();
      });
    });
    document.getElementById("qrText").addEventListener("input", updateQRCode);
    document.getElementById("dotShape").addEventListener("change", updateQRCode);

    document.getElementById("logoInput").addEventListener("change", function(e) {
      if (!e.target.files || !e.target.files[0]) return;
      const file = e.target.files[0];
      centerLogoType = file.type ? file.type.toLowerCase() : '';
      centerLogoName = file.name ? file.name.toLowerCase() : '';
      const reader = new FileReader();
      reader.onload = function(event) {
        qrCode.update({ image: event.target.result });
        document.getElementById("logoPreview").src = event.target.result;
        document.getElementById("logoPreview").style.display = 'block';
        updateDownloadButtons();
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("bgImageInput").addEventListener("change", function(e) {
      if (!e.target.files || !e.target.files[0]) return;
      const file = e.target.files[0];
      backgroundImageType = file.type ? file.type.toLowerCase() : '';
      backgroundImageName = file.name ? file.name.toLowerCase() : '';
      const reader = new FileReader();
      reader.onload = function(event) {
        backgroundImageData = event.target.result;
        // Show background image under QR code
        const bgLayer = document.getElementById("bgImageLayer");
        bgLayer.src = event.target.result;
        bgLayer.style.display = 'block';
        bgLayer.style.opacity = backgroundImageOpacity;
        // Set background color to transparent when image is selected
        document.getElementById("bgColor").value = "#00000000";
        updateDownloadButtons();
        updateQRCode();
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("toggleBgOpacityBtn").addEventListener("click", function() {
      backgroundImageOpacity = backgroundImageOpacity === 1 ? 0.4 : 1;
      const bgLayer = document.getElementById("bgImageLayer");
      bgLayer.style.opacity = backgroundImageOpacity;
    });

    document.getElementById("removeBgImageBtn").addEventListener("click", function() {
      backgroundImageData = null;
      backgroundImageType = null;
      const bgLayer = document.getElementById("bgImageLayer");
      bgLayer.src = "";
      bgLayer.style.display = 'none';
      document.getElementById("bgColor").value = "#ffffff";
      updateDownloadButtons();
      updateQRCode();
    });

    // Download buttons
    const downloadBtn = document.getElementById("download-btn");
    downloadBtn.addEventListener("click", () => {
      // If background image is present, merge it with QR code for PNG
      if (backgroundImageData) {
        const qrDiv = document.getElementById("qr-code");
        const qrCanvas = qrDiv.querySelector("canvas");
        if (qrCanvas) {
          const size = 300;
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = size;
          tempCanvas.height = size;
          const ctx = tempCanvas.getContext("2d");
          // Draw background image
          const img = new window.Image();
          img.onload = function() {
            ctx.globalAlpha = backgroundImageOpacity;
            ctx.drawImage(img, 0, 0, size, size);
            ctx.globalAlpha = 1;
            // Draw QR code
            ctx.drawImage(qrCanvas, 0, 0, size, size);
            // Download
            const link = document.createElement('a');
            link.download = "fancy-qr.png";
            link.href = tempCanvas.toDataURL("image/png");
            link.click();
          };
          img.src = backgroundImageData;
        }
      } else {
        qrCode.download({ name: "fancy-qr", extension: "png" });
      }
    });

    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', function() {
      document.body.classList.toggle('dark-mode', this.checked);
    });

    function setControlsDisabled(disabled) {
      document.getElementById('dotColor').disabled = disabled;
      document.getElementById('bgColor').disabled = disabled;
      document.getElementById('dotShape').disabled = disabled;
      document.getElementById('logoInput').disabled = disabled;
      document.getElementById('bgImageInput').disabled = disabled;
      document.getElementById('toggleBgOpacityBtn').disabled = disabled;
      document.getElementById('removeBgImageBtn').disabled = disabled;
      document.getElementById('download-btn').disabled = disabled;
    }

    function isValidQRContent(text) {
      return text && text.trim().length > 0;
    }

    document.getElementById('qrText').addEventListener('input', function() {
      setControlsDisabled(!isValidQRContent(this.value));
      updateQRCode();
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('dark-mode');
      document.getElementById('darkModeToggle').checked = true;
      // Disable controls if no QR content
      setControlsDisabled(!isValidQRContent(document.getElementById('qrText').value));
      updateDownloadButtons();
    });

    function updateDownloadButtons() {
      // No SVG button to update
    }
  </script>
</body>
</html>
